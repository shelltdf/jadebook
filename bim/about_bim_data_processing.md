关于BIM数据处理（总结）

# 数据来源

目前主流平台：
* Autodesk Revit
* Dassault catia
* bentley

主流的格式
* rvt
* ifc
* 其他3D模型格式（非BIM格式）

其他平台
* 超图
* 广联达


# 数据结构

bim信息并不是传统的3d场景树的父子关系，而是基于element的方式。一个element表达一个基本元素，这个元素包含自己的属性集合。比如一堵墙，长宽高，密度，材料等等。而使用family表示一个可复用的对象，也就是族。每个文件包含n个element和n个family的库。当然外链文件也就不需要层级结构了，直接并列存在就可以了。

## 构建和族

构建本身还可以细分，比如一个构建包含了多个可视化对象，也或者根本没有可视化对象。构建也可以包含族的instance，通过对instance的transform的设置达到共享的目的。比如会议室里有10把一样的椅子。每个椅子的构建直接包含了一个族的instance对象和一个transfrom的偏移值。

族是一种共享结构，是可以循环引用的。

## 外链文件

实际操作中BIM的文件不是一个人在操作，根据实际业务层和工作流程拆分成多个文件协同工作。

## 参数化模型

BIM系统中并不是直接使用三角面和polygon来记录信息的。三角面只是应对外部导入的一些参考模型的。正常的elelment包含的都是参数化的模型定义。比如revit里叫做solid。所以BIM系统之间的差异多存在与对这些参数定义的解释的不同。


# 可视化方案

通过对BIM数据的了解，我们可以知道一些和传统场景图不通的地方：
* 没有直接定义的父子关系。
* 大部分数据都是参数化的模型。
* 文件存储的内容量巨大，动辄上百万对象。
* 材质系统是广义的材质，而不是传统场景图的表面材质。
* 渲染效果的要求跟传统引擎不同。需要支持一些制图有关的效果。
* 渲染模式并不要求实时更新，可以按需更新，也可以快速生成缓冲绘制。
* 构建的附加属性需要支持。
* 场景内容是全动态的，因为需要实时的操作隐藏属性。


# 数据处理方案

## 方案1

**简单的直接导出3D模型**

简单的从软件中导出fbx或者其他什么格式的整体文件。都不是bim格式。

好处：
1. 简单方便，无需开发。

坏处：
1. 整体导出大文件不利于可视化。
2. 无法正确包含构建的信息。
3. 文件精度无法控制。
4. 数据关系完全丢失。

比如revit输出FBX文件。虽然可以轻松的导入到max或者unity中，但是完全无法获取到构建信息了。revit输出的fbx是包含构建信息的，材质信息也使用了加密字段。导入max虽然能够识别部分信息，但是再次导出会全部丢失。revit导出的fbx文件是没有任何精度可选的，也没有任何选项可以设置。导出的文件三角化精度非常不合理，有些数据也会产生偏移的情况。


## 方案2
**导出IFC格式**

几乎所有的主流和非主流BIM软件都支持IFC格式，也都不需要特殊开发就能输出。

好处：
1. 标准规范。
2. 可以直接导出数据，无需开发。

坏处：
1. 一个没有对应工具和实现的规范，兼容性是最大的问题。
2. 出于商业目的考量，兼容性是有上限的。
3. 自己写处理工具，没有完美的代码实现库，也没有完美的编辑器。

比如revit导入导出IFC都有严重的问题。ifcplusplus实现有非常多的问题，只是一个半成品的实验库。XBIM没有深入研究，但是基于c#的实现也是个大问题。


## 方案3
**二次开发插件**

基于当前平台开发插件，并输出必要的信息，保存为自定义格式。

好处：
1. 直接从平台获取信息，第一手资料。
2. 灵活对应平台的不同设计和工作方式。
3. 还可以大量开发辅助性工具，在源头解决问题。


坏处：
1. 开发成本周期。
2. 试错成本。
3. 维护成本。


比如revit可以用c#方式直接开发输出插件。我的做法是导出成一个自定义的XML格式，然后写后续的处理工具来达到最后的目的。



# 数据处理算法和实现


## 几何对象的RAW和INDEX

## 材质合并

## 贴图合并(atlas texture)

## 八叉树

## LOD管理

## 模型精简

## 参数化/反参数化

## 存储压缩

## 显存优化
